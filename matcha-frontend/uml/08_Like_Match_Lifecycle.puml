@startuml
skinparam DPI 300
title Like & Match Lifecycle - POST/DELETE /api/user/liked

participant Client_A
participant "Backend API" as API
participant WebSocket_B
participant Client_B

note over Client_A, Client_B
User A likes User B
end note

Client_A -> API: POST /api/user/liked\nAuth: Bearer <tokenA>\n{userid: "userB_id"}
activate API

API --> Client_A: HTTP 400\n{msg: "Cannot like yourself"}\nIf liking self
deactivate API

Client_A -> API: POST /api/user/liked\nAuth: Bearer <tokenA>\n{userid: "nonexistent"}
activate API
API --> Client_A: HTTP 404\n{msg: "User not found"}
deactivate API

Client_A -> API: POST /api/user/liked\nAuth: Bearer <tokenA>\n{userid: "blockedBy"}
activate API
API --> Client_A: HTTP 403\n{msg: "Cannot like blocked user"}\nOr target user blocked you
deactivate API

Client_A -> API: POST /api/user/liked\nAuth: Bearer <tokenA>\n{userid: "userB_id"}\nAlready liked
activate API
API --> Client_A: HTTP 409\n{msg: "You already liked this user"}
deactivate API

Client_A -> API: POST /api/user/liked\nAuth: Bearer <tokenA>\n{userid: "userB_id"}\nNew like
activate API

API --> Client_A: HTTP 200\n{msg: "liked"}
deactivate API

API -> WebSocket_B: socket.emit('notification')\n{type: 'LIKE', message: "User A liked your profile!"}
WebSocket_B -> Client_B: Receive notification
Client_B --> Client_B: Show like notification

note over Client_A, Client_B
Check if mutual like (match)
end note

Client_A -> API: GET /api/user/liked/matched\nAuth: Bearer <tokenA>
activate API
API --> Client_A: HTTP 200\n{data: [ProfileShort[]]}\nIncludes User B if mutual like
deactivate API

Client_B -> API: GET /api/user/liked/matched\nAuth: Bearer <tokenB>
activate API
API --> Client_B: HTTP 200\n{data: [ProfileShort[]]}\nIncludes User A if mutual like
deactivate API

note over Client_A, Client_B
Get users who liked you
end note

Client_B -> API: GET /api/user/liked/by\nAuth: Bearer <tokenB>
activate API
API --> Client_B: HTTP 200\n{data: [ProfileShort[]]}\nIncludes User A who just liked
deactivate API

note over Client_A, Client_B
User A unlikes User B
end note

Client_A -> API: DELETE /api/user/liked\nAuth: Bearer <tokenA>\n{userid: "userB_id"}
activate API

API --> Client_A: HTTP 404\n{msg: "Like not found"}\nIf never liked
deactivate API

Client_A -> API: DELETE /api/user/liked\nAuth: Bearer <tokenA>\n{userid: "userB_id"}\nPreviously liked
activate API

API --> Client_A: HTTP 200\n{msg: "unliked"}
deactivate API

API -> WebSocket_B: socket.emit('notification')\n{type: 'UNLIKE', message: "User A unliked your profile"}
WebSocket_B -> Client_B: Receive unlike notification
Client_B --> Client_B: Show unlike notification

note over Client_A, Client_B
After unlike - check matched status
end note

Client_A -> API: GET /api/user/liked/matched\nAuth: Bearer <tokenA>
activate API
API --> Client_A: HTTP 200\n{data: [ProfileShort[]]}\nUser B removed if was match\nOr kept if User B still likes User A
deactivate API

Client_B -> API: GET /api/user/liked/matched\nAuth: Bearer <tokenB>
activate API
API --> Client_B: HTTP 200\n{data: [ProfileShort[]]}\nUser A removed from matches\nBut User B's like still exists
deactivate API

note over Client_A, Client_B
Check connection status on profiles
end note

Client_A -> API: GET /api/profile/short/:userB_id\nAuth: Bearer <tokenA>
activate API
API --> Client_A: HTTP 200\n{ProfileShort:\n  {...,\n    connectionStatus: {\n      userid: "userB_id",\n      liked: false (after unlike),\n      likedBack: false,\n      matched: false\n    }\n  }\n}
deactivate API

Client_B -> API: GET /api/profile/short/:userA_id\nAuth: Bearer <tokenB>
activate API
API --> Client_B: HTTP 200\n{ProfileShort:\n  {...,\n    connectionStatus: {\n      userid: "userA_id",\n      liked: false,\n      likedBack: true (User B still likes),\n      matched: false\n    }\n  }\n}
deactivate API

note over Client_A, Client_B
User B likes User A (now mutual)
end note

Client_B -> API: POST /api/user/liked\nAuth: Bearer <tokenB>\n{userid: "userA_id"}
activate API

API --> Client_B: HTTP 200\n{msg: "liked"}\nNo more mutual since User A unliked
deactivate API

API -> WebSocket_A: socket.emit('notification')\n{type: 'LIKE', message: "User B liked your profile!"}
WebSocket_A -> Client_A: Receive like notification

note over Client_A, Client_B
Verify connection status reflects reality
end note

Client_A -> API: GET /api/profile/short/:userB_id\nAuth: Bearer <tokenA>
activate API
API --> Client_A: HTTP 200\n{ProfileShort:\n  {...,\n    connectionStatus: {\n      userid: "userB_id",\n      liked: false,\n      likedBack: true (User B likes),\n      matched: false\n    }\n  }\n}
deactivate API

Client_B -> API: GET /api/profile/short/:userA_id\nAuth: Bearer <tokenB>
activate API
API --> Client_B: HTTP 200\n{ProfileShort:\n  {...,\n    connectionStatus: {\n      userid: "userA_id",\n      liked: true (User B likes),\n      likedBack: false,\n      matched: false\n    }\n  }\n}
deactivate API

@enduml
