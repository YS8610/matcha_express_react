services:
  neo4j:
    image: neo4j:latest
    container_name: matcha-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME}/${NEO4J_PASSWORD}
      - NEO4J_server_config_strict__validation_enabled=false
      - NEO4J_server_memory_heap_initial__size=1G
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=1G
    volumes:
      - neo4j_data:/data
    healthcheck:
      test: ["CMD-SHELL", "echo RETURN 1 | cypher-shell -a bolt://localhost:7687 -u ${NEO4J_USERNAME} -p ${NEO4J_PASSWORD} || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  mongodb:
    image: mongo:latest
    container_name: matcha-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=matcha
    volumes:
      - mongodb_data:/data/db
    command: mongod --quiet --logpath=/dev/null --bind_ip_all
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  backend:
     build:
       context: ./matcha-backend
       dockerfile: Dockerfile
       cache_from:
         - matcha-backend:latest
     container_name: matcha-backend
     ports:
       - "8080:8080"
     env_file:
       - .env
     environment:
       - PORT=8080
       - NEO4J_URI=${NEO4J_URI}
       - MONGODB=${MONGODB}
     volumes:
       - ./matcha-backend/photoDump:/app/photoDump
       - ./matcha-backend/logs:/app/logs
     depends_on:
       neo4j:
         condition: service_healthy
       mongodb:
         condition: service_healthy
     command: sh -c "sleep 10 && npm run serve"

  frontend:
     build:
       context: ./matcha-frontend
       dockerfile: Dockerfile
       cache_from:
         - matcha-frontend:latest
       args:
         - NEXT_PUBLIC_API_URL=http://localhost:8080
         - NEXT_PUBLIC_WS_URL=http://localhost:8080
     container_name: matcha-frontend
     ports:
       - "3000:3000"
     environment:
       - NEXT_PUBLIC_API_URL=http://localhost:8080
       - NEXT_PUBLIC_WS_URL=http://localhost:8080
     depends_on:
       - backend

volumes:
  neo4j_data:
  mongodb_data:
